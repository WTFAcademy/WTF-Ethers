---
title: 28. æ£€æµ‹åˆçº¦åˆ›å»º2
tags:
  - ethers
  - javascript
  - provider
  - contract
  - create
  - create2
  - debug
  - trace
  - frontend
  - web
---

# WTF Ethers: 28. æ£€æµ‹åˆçº¦åˆ›å»º2

æˆ‘æœ€è¿‘åœ¨é‡æ–°å­¦ä¹ `ethers.js`ï¼Œå·©å›ºä¸€ä¸‹ç»†èŠ‚ï¼Œä¹Ÿå†™ä¸€ä¸ª`WTF Ethers`æç®€å…¥é—¨ï¼Œä¾›å°ç™½ä»¬ä½¿ç”¨ã€‚

**æ¨ç‰¹**ï¼š[@0xAA_Science](https://twitter.com/0xAA_Science)

**ç¤¾åŒº**ï¼š[Website wtf.academy](https://wtf.academy) | [WTF Solidity](https://github.com/AmazingAng/WTFSolidity) | [discord](https://discord.gg/5akcruXrsk) | [å¾®ä¿¡ç¾¤ç”³è¯·](https://docs.google.com/forms/d/e/1FAIpQLSe4KGT8Sh6sJ7hedQRuIYirOoZK_85miz3dw7vA1-YjodgJ-A/viewform?usp=sf_link)

æ‰€æœ‰ä»£ç å’Œæ•™ç¨‹å¼€æºåœ¨github: [github.com/WTFAcademy/WTF-Ethers](https://github.com/WTFAcademy/WTF-Ethers)

-----

ä¸Šä¸€è®²ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†é€šè¿‡æ£€æŸ¥äº¤æ˜“ `to == null` æ¥è¯†åˆ«åˆçº¦åˆ›å»ºã€‚è¿™ç§æ–¹æ³•ç®€å•æœ‰æ•ˆï¼Œä½†æœ‰å±€é™æ€§ï¼šæ— æ³•æ£€æµ‹åˆçº¦å†…éƒ¨è°ƒç”¨åˆ›å»ºçš„æ–°åˆçº¦ï¼Œæ¯”å¦‚ Uniswap å·¥å‚åˆçº¦åˆ›å»ºçš„æ–°LPä»£å¸åˆçº¦ã€‚è¿™ä¸€è®²ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•ä»å­—èŠ‚ç çš„å±‚é¢æ£€æµ‹åˆçº¦åˆ›å»ºï¼šé€šè¿‡åˆ†æäº¤æ˜“çš„è°ƒç”¨è¿½è¸ªï¼ˆcall traceï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥æ£€æµ‹åˆ°æ‰€æœ‰ç±»å‹çš„åˆçº¦åˆ›å»ºã€‚

## 1. åˆçº¦åˆ›å»ºçš„æœ¬è´¨

åœ¨æ·±å…¥æ£€æµ‹æ–¹æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ç†è§£åˆçº¦åˆ›å»ºåœ¨å­—èŠ‚ç å±‚é¢çš„æœ¬è´¨ã€‚åœ¨ä»¥å¤ªåŠè™šæ‹Ÿæœºï¼ˆEVMï¼‰ä¸­ï¼Œåˆ›å»ºåˆçº¦æœ¬è´¨ä¸Šæ˜¯æ‰§è¡Œä»¥ä¸‹ä¸¤ç§æ“ä½œç ä¹‹ä¸€ï¼š

### CREATE æ“ä½œç 
- **åŠŸèƒ½**ï¼šæ ¹æ®å‘é€è€…åœ°å€å’Œnonceè®¡ç®—æ–°åˆçº¦åœ°å€
- **åœ°å€è®¡ç®—**ï¼š`keccak256(rlp([sender_address, nonce]))`
- **ç‰¹ç‚¹**ï¼šåœ°å€å¯é¢„æµ‹ï¼Œä½†ä¾èµ–äºéƒ¨ç½²é¡ºåº

### CREATE2 æ“ä½œç   
- **åŠŸèƒ½**ï¼šæ ¹æ®å‘é€è€…åœ°å€ã€saltå€¼å’Œåˆçº¦å­—èŠ‚ç è®¡ç®—æ–°åˆçº¦åœ°å€
- **åœ°å€è®¡ç®—**ï¼š`keccak256(0xff + sender_address + salt + keccak256(bytecode))`
- **ç‰¹ç‚¹**ï¼šåœ°å€å®Œå…¨ç¡®å®šï¼Œä¸ä¾èµ–äºéƒ¨ç½²é¡ºåº

æ— è®ºæ˜¯ç”¨æˆ·ç›´æ¥éƒ¨ç½²åˆçº¦ï¼Œè¿˜æ˜¯é€šè¿‡æ™ºèƒ½åˆçº¦å†…éƒ¨è°ƒç”¨åˆ›å»ºæ–°åˆçº¦ï¼Œæœ€ç»ˆéƒ½ä¼šæ‰§è¡Œ `CREATE` æˆ– `CREATE2` æ“ä½œç ï¼š

1. **ç›´æ¥åˆçº¦åˆ›å»º**ï¼šç”¨æˆ·ç›´æ¥éƒ¨ç½²åˆçº¦ï¼ˆ`to == null`ï¼‰ï¼ŒEVM åº•å±‚æ‰§è¡Œ `CREATE` æ“ä½œç ã€‚
2. **å†…éƒ¨åˆçº¦åˆ›å»º**ï¼šç”¨æˆ·è°ƒç”¨å·¥å‚åˆçº¦ï¼Œå·¥å‚åˆçº¦å†…éƒ¨è°ƒç”¨ `CREATE` æˆ– `CREATE2` æ“ä½œç ã€‚

æ¯”å¦‚æˆ‘ä»¬ä¸‹é¢è¿™ç¬”[äº¤æ˜“](https://bscscan.com/tx/0x553073c1740e608255fc182dc58aa4c2fdfdb7d6d3c5fb8738a5518dc2c996d6#internal)å°±è°ƒç”¨äº† `CREATE2` æ“ä½œç ï¼Œé€šè¿‡åˆçº¦é€»è¾‘åˆ›å»ºäº†æ–°çš„åˆçº¦ï¼š

![](./img/29-1.png)

å¦‚æœä½ å¯¹ EVM å­—èŠ‚ç æ„Ÿå…´è¶£ï¼Œå¯ä»¥é˜…è¯»[WTF EVM Opcodesæ•™ç¨‹](https://github.com/WTFAcademy/WTF-EVM-Opcodes)ï¼Œé‡Œé¢ä»‹ç»äº†EVMä¸­çš„144ä¸ªæ“ä½œç ã€‚

## 2. è·å–call trace

æ—¢ç„¶åˆ›å»ºåˆçº¦ä¸€å®šè¦ä½¿ç”¨ `CREATE` æˆ– `CREATE2` æ“ä½œç ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä»å“ªé‡Œè·å–äº¤æ˜“çš„æ“ä½œç ä¿¡æ¯å‘¢ï¼Ÿ

ç­”æ¡ˆå°±æ˜¯ EVM çš„ call traceï¼ˆè°ƒç”¨è¿½è¸ªï¼‰:å®ƒæŠŠä¸€ç¬”äº¤æ˜“åœ¨ EVM é‡Œçš„æ¶ˆæ¯è°ƒç”¨æ ‘å¤åŸå‡ºæ¥ï¼Œå±•ç¤ºè°ï¼ˆfromï¼‰è°ƒç”¨äº†è°ï¼ˆtoï¼‰ã€ä¼ äº†ä»€ä¹ˆæ•°æ®ï¼ˆinputï¼‰ã€è½¬äº†å¤šå°‘é’±ï¼ˆvalueï¼‰ã€æ˜¯å¦ REVERTã€æ¶ˆè€—äº†å¤šå°‘ gasï¼Œä»¥åŠæ˜¯å¦åœ¨è¿‡ç¨‹ä¸­ CREATE/CREATE2 äº†æ–°åˆçº¦ã€‚å®ƒä¹Ÿæ˜¯åŒºå—æµè§ˆå™¨ä¸­å†…éƒ¨äº¤æ˜“ï¼ˆInternal Transactionï¼‰çš„æ•°æ®æ¥æºã€‚

call trace çš„é¢—ç²’åº¦ä¸æ˜¯ opcode çº§åˆ«ï¼Œè€Œæ˜¯â€œæ¶ˆæ¯è°ƒç”¨â€çº§åˆ«ï¼Œåªè®°å½•äº† `CALL/DELEGATECALL/STATICCALL/CREATE/CREATE2/SELFDESTRUCT` è¿™6ç§è°ƒç”¨çº§çš„ opcodeã€‚è¿™é‡Œé¢æ­£å¥½æœ‰æˆ‘ä»¬éœ€è¦çš„ `CREATE/CREATE2`ã€‚

ä¸€èˆ¬çš„ä»¥å¤ªåŠèŠ‚ç‚¹éƒ½æ˜¯ç”¨çš„ GETHï¼Œæä¾›äº†ä¸¤ä¸ª `debug` æ¥å£ä¾›å¼€å‘è€…è·å– call trace:

1. `debug_traceTransaction`: é‡æ”¾å•ç¬”äº¤æ˜“ï¼Œå¯ä»¥ç”¨æ¥è·å–å•ç¬”äº¤æ˜“çš„ call traceã€‚

2. `debug_traceBlockByNumber`: é‡æ”¾æ•´å—æ‰€æœ‰äº¤æ˜“ï¼Œå¯ä»¥ç”¨æ¥è·å–æ•´ä¸ªåŒºå—æ‰€æœ‰äº¤æ˜“çš„ call traceã€‚

å› ä¸º `debug` æ¥å£åªæ˜¯ Geth å®¢æˆ·ç«¯çš„æ‰©å±•åŠŸèƒ½ï¼Œè€Œä¸æ˜¯ä»¥å¤ªåŠæ ‡å‡†çš„ä¸€éƒ¨åˆ†ï¼Œå› æ­¤ ethers.js å¹¶æ²¡æœ‰æ”¯æŒï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ `fetch` æˆ–å…¶ä»–å·¥å…·è°ƒç”¨ã€‚å¦å¤– `debug` æ¥å£ä¼šæ¶ˆè€—è®¡ç®—èµ„æºå’Œå­˜å‚¨ç©ºé—´ï¼Œå¤§éƒ¨åˆ†å…¬å…± RPC èŠ‚ç‚¹ä¼šé»˜è®¤å…³é—­ï¼Œè€Œä»˜è´¹èŠ‚ç‚¹ä¹Ÿå¯èƒ½å…³é—­æˆ–åªä¿ç•™æœ€è¿‘128ä¸ªåŒºå—çš„debugæ•°æ®ã€‚æˆ‘æ¨è ZAN çš„æ¥å£ï¼Œå…¬å…±çš„RPCå°±å·²ç»æ”¯æŒäº† `debug` æ¥å£ï¼Œä½†è°ƒç”¨é¢‘ç‡é™åˆ¶å¾ˆå¤§ï¼Œç§æœ‰èŠ‚ç‚¹å¯ä»¥å»å®˜ç½‘æ³¨å†Œ `https://zan.top/`ã€‚

ä¸‹é¢æˆ‘ä»¬ä»¥è°ƒç”¨ `debug_traceTransaction` è·å–å•ç¬”[äº¤æ˜“](https://bscscan.com/tx/0x553073c1740e608255fc182dc58aa4c2fdfdb7d6d3c5fb8738a5518dc2c996d6)çš„ call trace ä¸ºä¾‹ï¼š

```js
// è·å–äº¤æ˜“çš„traceè°ƒç”¨ä¿¡æ¯
const RPC_URL = "https://api.zan.top/bsc-mainnet";

// RPCè°ƒç”¨å‡½æ•°
async function makeRPCCall(method, params = []) {
  const response = await fetch(RPC_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      jsonrpc: '2.0',
      method,
      params,
      id: Date.now()
    })
  });

  const data = await response.json();
  
  if (data.error) {
    throw new Error(`RPCé”™è¯¯: ${data.error.message}`);
  }
  
  return data.result;
}

// é€’å½’è¾“å‡ºæ‰€æœ‰è°ƒç”¨
function logAllCalls(trace, depth = 0) {
  if (!trace) return;
  
  const indent = '  '.repeat(depth);
  
  console.log(`${indent}ğŸ“ è°ƒç”¨ä¿¡æ¯:`);
  console.log(`${indent}   ç±»å‹: ${trace.type}`);
  console.log(`${indent}   å‘é€è€…: ${trace.from}`);
  console.log(`${indent}   æ¥æ”¶è€…: ${trace.to}`);
  console.log(`${indent}   Gas: ${trace.gas}`);
  console.log(`${indent}   Gasä½¿ç”¨: ${trace.gasUsed}`);
  console.log(`${indent}   å€¼: ${trace.value || '0x0'}`);
  
  if (trace.input && trace.input.length > 10) {
    console.log(`${indent}   è¾“å…¥æ•°æ®: ${trace.input.substring(0, 42)}...`);
  }
  
  if (trace.output && trace.output.length > 2) {
    console.log(`${indent}   è¾“å‡ºæ•°æ®: ${trace.output.substring(0, 42)}...`);
  }
  
  if (trace.error) {
    console.log(`${indent}   âŒ é”™è¯¯: ${trace.error}`);
  }
  
  console.log(`${indent}   æ·±åº¦: ${depth}`);
  console.log('');
  
  // é€’å½’å¤„ç†å­è°ƒç”¨
  if (trace.calls && Array.isArray(trace.calls)) {
    console.log(`${indent}ğŸ”— å­è°ƒç”¨ (${trace.calls.length}ä¸ª):`);
    trace.calls.forEach((call, index) => {
      console.log(`${indent}--- å­è°ƒç”¨ ${index + 1} ---`);
      logAllCalls(call, depth + 1);
    });
  }
}

// ä¸»å‡½æ•°
async function traceTransaction() {
  const txHash = '0x553073c1740e608255fc182dc58aa4c2fdfdb7d6d3c5fb8738a5518dc2c996d6';
  
  console.log('ğŸ” è·å–äº¤æ˜“traceè°ƒç”¨ä¿¡æ¯');
  console.log('============================');
  console.log(`äº¤æ˜“å“ˆå¸Œ: ${txHash}`);
  console.log(`RPCç«¯ç‚¹: ${RPC_URL}\n`);
  
  try {
    // è·å–äº¤æ˜“åŸºæœ¬ä¿¡æ¯
    console.log('ğŸ“‹ è·å–äº¤æ˜“åŸºæœ¬ä¿¡æ¯...');
    const tx = await makeRPCCall('eth_getTransactionByHash', [txHash]);
    
    if (!tx) {
      throw new Error('äº¤æ˜“æœªæ‰¾åˆ°');
    }
    
    console.log(`âœ… äº¤æ˜“ä¿¡æ¯:`);
    console.log(`   åŒºå—å·: ${parseInt(tx.blockNumber, 16)}`);
    console.log(`   å‘é€è€…: ${tx.from}`);
    console.log(`   æ¥æ”¶è€…: ${tx.to || 'åˆçº¦åˆ›å»º'}`);
    console.log(`   Gasé™åˆ¶: ${parseInt(tx.gas, 16).toLocaleString()}`);
    console.log(`   Gasä»·æ ¼: ${parseInt(tx.gasPrice, 16)} wei`);
    console.log(`   å€¼: ${tx.value} wei`);
    console.log('');
    
    // è·å–äº¤æ˜“å›æ‰§
    console.log('ğŸ“‹ è·å–äº¤æ˜“å›æ‰§...');
    const receipt = await makeRPCCall('eth_getTransactionReceipt', [txHash]);
    
    if (receipt) {
      console.log(`âœ… äº¤æ˜“å›æ‰§:`);
      console.log(`   çŠ¶æ€: ${receipt.status === '0x1' ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}`);
      console.log(`   Gasä½¿ç”¨: ${parseInt(receipt.gasUsed, 16).toLocaleString()}`);
      console.log(`   åˆçº¦åœ°å€: ${receipt.contractAddress || 'æ— '}`);
      console.log(`   æ—¥å¿—æ•°é‡: ${receipt.logs.length}`);
      console.log('');
    }
    
    // è·å–traceè°ƒç”¨
    console.log('ğŸ” è·å–traceè°ƒç”¨ä¿¡æ¯...');
    const traceOptions = {
      tracer: "callTracer",
      timeout: "30s"
    };
    
    const trace = await makeRPCCall('debug_traceTransaction', [txHash, traceOptions]);
    
    console.log('âœ… Traceè°ƒç”¨ä¿¡æ¯:');
    console.log('==================\n');
    
    // è¾“å‡ºæ‰€æœ‰è°ƒç”¨
    logAllCalls(trace);
    
    console.log('âœ… åˆ†æå®Œæˆ!');
    
  } catch (error) {
    console.error('âŒ é”™è¯¯:', error.message);
  }
}

// è¿è¡Œ
traceTransaction(); 
```

è¾“å‡ºå¦‚ä¸‹ã€‚å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬æˆåŠŸè·å–åˆ°äº†è¿™ç¬”äº¤æ˜“çš„ call traceï¼Œå¹¶ä¸”èƒ½çœ‹åˆ°å…¶ä¸­ä¸€ä¸ªå­è°ƒç”¨ä½¿ç”¨äº† `CREATE2` å­—èŠ‚ç ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ç¬”äº¤æ˜“åˆ›å»ºäº†æ–°åˆçº¦ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨è¿™ç§æ–¹æ³•ç­›é€‰äº¤æ˜“æ˜¯å¦åŒ…å«åˆçº¦åˆ›å»ºï¼Œä¸è®ºç›´æ¥æˆ–é—´æ¥ã€‚

```shell
ğŸ” è·å–äº¤æ˜“traceè°ƒç”¨ä¿¡æ¯
============================
äº¤æ˜“å“ˆå¸Œ: 0x553073c1740e608255fc182dc58aa4c2fdfdb7d6d3c5fb8738a5518dc2c996d6

ğŸ“‹ è·å–äº¤æ˜“åŸºæœ¬ä¿¡æ¯...
âœ… äº¤æ˜“ä¿¡æ¯:
   åŒºå—å·: 62635612
   å‘é€è€…: 0x4337009be43c7ecc9bfbde0f1780553aa065187e
   æ¥æ”¶è€…: 0x0000000071727de22e5e9d8baf0edac6f37da032
   Gasé™åˆ¶: 1,162,316
   Gasä»·æ ¼: 115000000 wei
   å€¼: 0x0 wei

ğŸ“‹ è·å–äº¤æ˜“å›æ‰§...
âœ… äº¤æ˜“å›æ‰§:
   çŠ¶æ€: âœ… æˆåŠŸ
   Gasä½¿ç”¨: 765,791
   åˆçº¦åœ°å€: æ— 
   æ—¥å¿—æ•°é‡: 25

ğŸ” è·å–traceè°ƒç”¨ä¿¡æ¯...
âœ… Traceè°ƒç”¨ä¿¡æ¯:
==================

ğŸ“ è°ƒç”¨ä¿¡æ¯:
   ç±»å‹: CALL
   å‘é€è€…: 0x4337009be43c7ecc9bfbde0f1780553aa065187e
   æ¥æ”¶è€…: 0x0000000071727de22e5e9d8baf0edac6f37da032
   Gas: 0x11bc4c
   Gasä½¿ç”¨: 0xbaf5f
   å€¼: 0x0
   è¾“å…¥æ•°æ®: 0x765e827f00000000000000000000000000000000...
   æ·±åº¦: 0

ğŸ”— å­è°ƒç”¨ (5ä¸ª):
--- å­è°ƒç”¨ 1 ---
  ğŸ“ è°ƒç”¨ä¿¡æ¯:
     ç±»å‹: CALL
     å‘é€è€…: 0x0000000071727de22e5e9d8baf0edac6f37da032
     æ¥æ”¶è€…: 0xefc2c1444ebcc4db75e7613d20c6a62ff67a167c
     Gas: 0x52a0a
     Gasä½¿ç”¨: 0x2686b
     å€¼: 0x0
     è¾“å…¥æ•°æ®: 0x570e1a3600000000000000000000000000000000...
     è¾“å‡ºæ•°æ®: 0x000000000000000000000000e56594d73da2c920...
     æ·±åº¦: 1

  ğŸ”— å­è°ƒç”¨ (1ä¸ª):
  --- å­è°ƒç”¨ 1 ---
    ğŸ“ è°ƒç”¨ä¿¡æ¯:
       ç±»å‹: CALL
       å‘é€è€…: 0xefc2c1444ebcc4db75e7613d20c6a62ff67a167c
       æ¥æ”¶è€…: 0xd703aae79538628d27099b8c4f621be4ccd142d5
       Gas: 0x50925
       Gasä½¿ç”¨: 0x25bc8
       å€¼: 0x0
       è¾“å…¥æ•°æ®: 0xc5265d5d000000000000000000000000aac5d424...
       è¾“å‡ºæ•°æ®: 0x000000000000000000000000e56594d73da2c920...
       æ·±åº¦: 2

    ğŸ”— å­è°ƒç”¨ (1ä¸ª):
    --- å­è°ƒç”¨ 1 ---
      ğŸ“ è°ƒç”¨ä¿¡æ¯:
         ç±»å‹: CALL
         å‘é€è€…: 0xd703aae79538628d27099b8c4f621be4ccd142d5
         æ¥æ”¶è€…: 0xaac5d4240af87249b3f71bc8e4a2cae074a3e419
         Gas: 0x4df35
         Gasä½¿ç”¨: 0x24462
         å€¼: 0x0
         è¾“å…¥æ•°æ®: 0xea6d13ac00000000000000000000000000000000...
         è¾“å‡ºæ•°æ®: 0x000000000000000000000000e56594d73da2c920...
         æ·±åº¦: 3

      ğŸ”— å­è°ƒç”¨ (2ä¸ª):
      --- å­è°ƒç”¨ 1 ---
        ğŸ“ è°ƒç”¨ä¿¡æ¯:
           ç±»å‹: CREATE2
           å‘é€è€…: 0xaac5d4240af87249b3f71bc8e4a2cae074a3e419
           æ¥æ”¶è€…: 0xe56594d73da2c920c07380902dcf1336190a9829
           Gas: 0x44c4f
           Gasä½¿ç”¨: 0x8621
           å€¼: 0x0
           è¾“å…¥æ•°æ®: 0x603d3d8160223d3973bac849bb641841b44e965f...
           è¾“å‡ºæ•°æ®: 0x363d3d373d3d363d7f360894a13ba1a3210667c8...
           æ·±åº¦: 4
...
```

## 3. æ‰¹é‡ç­›é€‰åŒºå—

æˆ‘ä»¬åœ¨ä¸Šä¸€èŠ‚è°ƒç”¨ `debug_traceTransaction` è·å–äº†å•ç¬”äº¤æ˜“çš„ call traceï¼Œä½†é€ç¬”è°ƒç”¨çš„æ•ˆç‡å¾ˆä½ã€‚è€Œ `debug_traceBlockByNumber` æ¥å£å¯ä»¥è®©æˆ‘ä»¬è·å¾—æ•´ä¸ªåŒºå—æ‰€æœ‰äº¤æ˜“çš„ call traceï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½ä¸€æ¬¡æ£€æµ‹æ•´ä¸ªåŒºå—çš„åˆçº¦åˆ›å»ºäº¤æ˜“ï¼š

```js
const blockHex = '0x' + blockNumber.toString(16);

// è·å–åŒºå—ä¿¡æ¯
const block = await makeRPCCall('eth_getBlockByNumber', [blockHex, true]);

if (!block) {
    throw new Error('åŒºå—æœªæ‰¾åˆ°');
}

console.log(` åŒºå— ${blockNumber} - äº¤æ˜“æ•°é‡: ${block.transactions.length}`);

// æ‰¹é‡è¿½è¸ªæ•´ä¸ªåŒºå—
const traceOptions = {
    tracer: "callTracer",
    timeout: "30s"
};

console.log(' æ‰§è¡Œæ‰¹é‡è¿½è¸ª...');
const blockTraces = await makeRPCCall('debug_traceBlockByNumber', [blockHex, traceOptions]);
console.log(blockTraces)
```

å°±ä¼šè¾“å‡ºæ•´ä¸ªåŒºå—æ¯ç¬”äº¤æ˜“çš„ call tracesï¼ˆå†…éƒ¨è°ƒç”¨åœ¨ calls æ•°ç»„ä¸­ï¼Œæœªå±•å¼€ï¼‰ã€‚

```shell
[
{
    txHash: '0xafc3b025084f3594ed797fb6498e09c31718c66c970e8300b19fef851f7955f4',
    result: {
      from: '0xc3825b451ea33a47b9ef07b00438f3965f0052fe',
      gas: '0x5208',
      gasUsed: '0x5208',
      to: '0xc6109fadbdf24ebb2be604a21fd05b17ccccd712',
      input: '0x',
      value: '0xd8de82cba03ae3',
      type: 'CALL'
    }
  },
  {
    txHash: '0x639500c97c2a22d9f841be96141889cf81bf719bc45d20c8f6faed27884efda7',
    result: {
      from: '0xce5f687f0ae6501605944fcf03a9ce35de80eed0',
      gas: '0x8d9a6',
      gasUsed: '0x4c3f6',
      to: '0x6015126d7d23648c2e4466693b8deab005ffaba8',
      input: '0xb80c2f090000000000000000000000000000000000000000000000000038e7d2b86c2940000000000000000000000000be7e12b2e128bc955a0130ffb168f031d7dd8d58000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee00000000000000000000000000000000000000000000000097d4ed04e0fb6000000000000000000000000000000000000000000000000000000471acef840e520000000000000000000000000000000000000000000000000000000068da746b0000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000006c0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000097d4ed04e0fb6000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000002a000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000160000000000000000000000000be7e12b2e128bc955a0130ffb168f031d7dd8d5800000000000000000000000000000000000000000000000000000000000000010000000000000000000000007a7ad9aa93cd0a2d0255326e5fb145cec14997ff00000000000000000000000000000000000000000000000000000000000000010000000000000000000000007a7ad9aa93cd0a2d0255326e5fb145cec14997ff000000000000000000000000000000000000000000000000000000000000000180000000000000000000271091e4b339d9add120f12e3884e007d8713cd5b70f0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000040000000000000000000000000be7e12b2e128bc955a0130ffb168f031d7dd8d580000000000000000000000008ac76a51cc950d9822d68b83fe1ad97b32cd580d00000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000001600000000000000000000000008ac76a51cc950d9822d68b83fe1ad97b32cd580d00000000000000000000000000000000000000000000000000000000000000010000000000000000000000007a7ad9aa93cd0a2d0255326e5fb145cec14997ff00000000000000000000000000000000000000000000000000000000000000010000000000000000000000007a7ad9aa93cd0a2d0255326e5fb145cec14997ff0000000000000000000000000000000000000000000000000000000000000001000000000000000000002710f2688fb5b81049dfb7703ada5e770543770612c40000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000400000000000000000000000008ac76a51cc950d9822d68b83fe1ad97b32cd580d000000000000000000000000bb4cdb9cbd36b01bd1cbaebf2de08d9173bc095c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee3ca20afc2bbb00000067c2806ea08ca8f313d860808ef7431fc72c6fbcf4a72d',
      output: '0x00000000000000000000000000000000000000000000000000047574e53f6899',
      calls: [Array],
      value: '0x0',
      type: 'CALL'
    }
  },
  {
    txHash: '0x3b06d1da676bbc5e915851fa8a6e50bf228fb78b42cb8471df8baa0db10901c4',
    result: {
      from: '0x086df1afd0c4049fe92cbb6fc6afaeb9e1299df5',
      gas: '0x1d512',
      gasUsed: '0x6e96',
      to: '0x1b6c409a930a9509590ac09b8a9664f67fd628d6',
      input: '0x43bc4cbf000000000000000000000000fa56e9abcaa45207be5e43cf475ee061768ca915000000000000000000000000000000000000000000000000000167d899498fe1000000000000000000000000000000000000000000000000386e5b225c0686ea',
      calls: [Array],
      value: '0x0',
      type: 'CALL'
    }
  },
...
]
```

ç„¶åæˆ‘ä»¬åœ¨ä½¿ç”¨é€’å½’çš„æ–¹æ³•ï¼Œæ£€æŸ¥æ¯ä¸ªè°ƒç”¨/å­è°ƒç”¨æ˜¯å¦åŒ…å« `CREATE` æˆ– `CREATE2` å­—èŠ‚ç å°±å¯ä»¥ç­›é€‰å‡ºåŒºå—ä¸­æ‰€æœ‰åˆçº¦åˆ›å»ºäº¤æ˜“ï¼š


```js
// åˆ†æè°ƒç”¨è¿½è¸ªä¸­çš„åˆçº¦åˆ›å»º
function findContractCreations(trace, txHash) {
  const creations = [];
  
  if (!trace) return creations;
  
  // æ£€æŸ¥æ˜¯å¦ä¸ºåˆçº¦åˆ›å»º
  if (trace.type === 'CREATE' || trace.type === 'CREATE2') {
    creations.push({
      txHash: txHash,
      type: trace.type,
      creator: trace.from,
      contractAddress: trace.to,
      gasUsed: trace.gasUsed,
      success: !trace.error
    });
  }
  
  // é€’å½’æ£€æŸ¥å­è°ƒç”¨
  if (trace.calls && Array.isArray(trace.calls)) {
    for (const call of trace.calls) {
      creations.push(...findContractCreations(call, txHash));
    }
  }
  
  return creations;
}
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ©ç”¨è¿™ä¸ªæ–¹æ³•ç­›é€‰BSCåŒºå— 62889542 ä¸­åˆçº¦åˆ›å»ºçš„äº¤æ˜“ã€‚ä»ä¸‹é¢çš„ç»“æœæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬æˆåŠŸçš„ä»è¿™ä¸ªåŒºå—çš„149ä¸ªäº¤æ˜“ä¸­ç­›é€‰å‡ºäº†åˆçº¦åˆ›å»º[äº¤æ˜“](https://bscscan.com/tx/0x48d4d6c523996a2c8a82ed6eaefda962b80f05749a2d386032563d5e993f0b06)ã€‚ä»åŒºå—æµè§ˆå™¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™æ˜¯ä¸€ä¸ªfour memeä¸Šåˆ›å»ºæ–°ä»£å¸çš„äº¤æ˜“ã€‚

```shell
ğŸ” åˆ†æåŒºå— 62889542...
 åŒºå— 62889542 - äº¤æ˜“æ•°é‡: 149
 æ‰§è¡Œæ‰¹é‡è¿½è¸ª...
 è·å–åˆ° 149 ä¸ªäº¤æ˜“çš„è¿½è¸ªæ•°æ®
ğŸ­ å†…éƒ¨åˆçº¦åˆ›å»º: 0x48d4d6c523996a2c8a82ed6eaefda962b80f05749a2d386032563d5e993f0b06 (1ä¸ª)

 åˆ†æç»“æœ:
   ç›´æ¥åˆçº¦åˆ›å»º: 0
   å†…éƒ¨åˆçº¦åˆ›å»º: 1
   æ€»åˆçº¦åˆ›å»º: 1

 åˆçº¦åˆ›å»ºåˆ—è¡¨:
1. internal - 0xc6e0a90b060f2503a8f9e129a13e31d6d57b4444
   åˆ›å»ºè€…: 0x757eba15a64468e6535532fcf093cef90e226f85
   äº¤æ˜“: 0x48d4d6c523996a2c8a82ed6eaefda962b80f05749a2d386032563d5e993f0b06

 åˆ†æå®Œæˆ!
```

![](./img/29-2.png)



## 4. æ³¨æ„äº‹é¡¹

1. RPCèŠ‚ç‚¹æ”¯æŒï¼šå¹¶éæ‰€æœ‰RPCèŠ‚ç‚¹éƒ½æ”¯æŒ `debug_traceBlockByNumber` æ–¹æ³•ï¼Œéœ€è¦ä»˜è´¹æˆ–è‡ªå»ºèŠ‚ç‚¹ã€‚
2. å†å²æ•°æ®é™åˆ¶ï¼šå¤§å¤šæ•°å…¬å…±RPCèŠ‚ç‚¹åªä¿ç•™æœ‰é™çš„å†å²è¿½è¸ªæ•°æ®ï¼Œæ¯”å¦‚æœ€è¿‘çš„128åŒºå—ã€‚

## 5. æ€»ç»“

è¿™ä¸€è®²æˆ‘ä»¬å­¦ä¹ äº†å¦‚ä½•ä½¿ç”¨`debug_traceBlockByNumber` ä¸€æ¬¡æ€§è·å–æ•´ä¸ªåŒºå—æ‰€æœ‰äº¤æ˜“çš„call traceï¼Œç„¶ååˆ©ç”¨å®ƒè¯†åˆ«åˆçº¦åˆ›å»ºäº¤æ˜“ã€‚è¿™ä¸ªæ–¹æ³•æ”¯æŒç›´æ¥åˆ›å»ºå’Œå†…éƒ¨åˆ›å»ºï¼Œä½†æ˜¯å¯¹RPCèŠ‚ç‚¹çš„è¦æ±‚æ›´é«˜ã€‚åˆ©ç”¨è¿™ä¸ªæ–¹æ³•ï¼Œä½ å¯ä»¥åœ¨ç¬¬ä¸€æ—¶é—´è·å–é“¾ä¸Šçš„æ–°åˆçº¦ï¼Œå…ˆäººä¸€æ­¥ã€‚